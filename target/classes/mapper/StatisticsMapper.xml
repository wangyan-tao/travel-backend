<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qingchun.travelloan.mapper.StatisticsMapper">

    <!-- 通用筛选条件 -->
    <sql id="userFilter">
        <if test="filter != null">
            <if test="filter.startDate != null">
                AND u.created_at &gt;= #{filter.startDate}
            </if>
            <if test="filter.endDate != null">
                AND u.created_at &lt;= #{filter.endDate}
            </if>
            <if test="filter.userType != null and filter.userType != 'ALL'">
                AND ui.user_type = #{filter.userType}
            </if>
        </if>
    </sql>

    <sql id="applicationFilter">
        <if test="filter != null">
            <if test="filter.startDate != null">
                AND la.created_at &gt;= #{filter.startDate}
            </if>
            <if test="filter.endDate != null">
                AND la.created_at &lt;= #{filter.endDate}
            </if>
        </if>
    </sql>

    <!-- 获取总用户数 -->
    <select id="getTotalUsers" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT u.id)
        FROM user u
        LEFT JOIN user_identity ui ON u.id = ui.user_id
        WHERE 1=1
        <include refid="userFilter"/>
    </select>

    <!-- 获取总申请数 -->
    <select id="getTotalApplications" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM loan_application la
        WHERE 1=1
        <include refid="applicationFilter"/>
    </select>

    <!-- 获取待审批数 -->
    <select id="getPendingApplications" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM loan_application la
        WHERE la.status = 'PENDING'
        <include refid="applicationFilter"/>
    </select>

    <!-- 获取总贷款金额 -->
    <select id="getTotalLoanAmount" resultType="java.lang.String">
        SELECT CONCAT('¥', FORMAT(COALESCE(SUM(loan_amount), 0) / 1000000, 1), 'M')
        FROM loan_application la
        WHERE la.status = 'APPROVED'
        <include refid="applicationFilter"/>
    </select>

    <!-- 获取用户增长数据 -->
    <select id="getUserGrowthData" resultType="com.qingchun.travelloan.dto.StatisticsDTO$UserGrowth">
        SELECT 
            DATE_FORMAT(MAX(u.created_at), '%m月') as month,
            COUNT(DISTINCT u.id) as users
        FROM user u
        LEFT JOIN user_identity ui ON u.id = ui.user_id
        WHERE 1=1
        <include refid="userFilter"/>
        GROUP BY DATE_FORMAT(u.created_at, '%Y-%m')
        ORDER BY DATE_FORMAT(u.created_at, '%Y-%m')
    </select>

    <!-- 获取贷款状态分布 -->
    <select id="getLoanStatusDistribution" resultType="com.qingchun.travelloan.dto.StatisticsDTO$LoanStatus">
        SELECT 
            CASE la.status
                WHEN 'APPROVED' THEN '已批准'
                WHEN 'PENDING' THEN '审批中'
                WHEN 'REJECTED' THEN '已拒绝'
                ELSE '其他'
            END as name,
            COUNT(*) as value,
            CASE la.status
                WHEN 'APPROVED' THEN '#10b981'
                WHEN 'PENDING' THEN '#f59e0b'
                WHEN 'REJECTED' THEN '#ef4444'
                ELSE '#6b7280'
            END as color
        FROM loan_application la
        WHERE 1=1
        <include refid="applicationFilter"/>
        GROUP BY la.status
    </select>

    <!-- 获取贷款产品分布 -->
    <select id="getLoanProductDistribution" resultType="com.qingchun.travelloan.dto.StatisticsDTO$LoanProduct">
        SELECT 
            lp.product_name as product,
            COUNT(la.id) as count
        FROM loan_product lp
        LEFT JOIN loan_application la ON lp.id = la.product_id
        <if test="filter != null">
            <if test="filter.startDate != null or filter.endDate != null">
                AND (la.id IS NULL
                <if test="filter.startDate != null">
                    OR la.created_at &gt;= #{filter.startDate}
                </if>
                <if test="filter.endDate != null">
                    OR la.created_at &lt;= #{filter.endDate}
                </if>
                )
            </if>
        </if>
        GROUP BY lp.id, lp.product_name
        ORDER BY count DESC
    </select>

    <!-- 获取还款情况 -->
    <select id="getRepaymentStatusData" resultType="com.qingchun.travelloan.dto.StatisticsDTO$RepaymentStatus">
        SELECT 
            DATE_FORMAT(MAX(rr.payment_time), '%m月') as month,
            SUM(CASE WHEN DATE(rr.payment_time) &lt;= rp.due_date THEN 1 ELSE 0 END) as onTime,
            SUM(CASE WHEN DATE(rr.payment_time) &gt; rp.due_date THEN 1 ELSE 0 END) as late
        FROM repayment_record rr
        LEFT JOIN repayment_plan rp ON rr.plan_id = rp.id
        WHERE 1=1
        <if test="filter != null">
            <if test="filter.startDate != null">
                AND rr.payment_time &gt;= #{filter.startDate}
            </if>
            <if test="filter.endDate != null">
                AND rr.payment_time &lt;= #{filter.endDate}
            </if>
        </if>
        GROUP BY DATE_FORMAT(rr.payment_time, '%Y-%m')
        ORDER BY DATE_FORMAT(rr.payment_time, '%Y-%m')
    </select>

</mapper>
