# 资质档案自动显示功能说明

## 功能需求

工作证明或荣誉上传后，自动在资质档案页面显示，下次申请贷款时可以直接复用，无需重复上传。

## 实现方案

### 1. 数据自动保存
- ✅ 上传工作证明时，数据自动保存到 `user_job_proof` 表
- ✅ 上传学业荣誉时，数据自动保存到 `academic_honor` 表
- ✅ 所有上传的数据都会自动关联到当前用户（通过 JWT Token 获取 userId）

### 2. 自动刷新机制

#### 前端实现
使用自定义事件 `archive-updated` 实现组件间通信：

1. **上传成功后触发事件**：
   - `PartTimeJobRecommendation.tsx`: 工作证明上传成功后触发 `archive-updated` 事件
   - `AcademicHonorUpload.tsx`: 学业荣誉上传成功后触发 `archive-updated` 事件

2. **资质档案组件监听事件**：
   - `QualificationArchive.tsx`: 监听 `archive-updated` 事件，自动刷新数据

#### 代码实现

**工作证明上传成功后**：
```typescript
if (response.data.code === 200) {
  toast.success('工作证明上传成功！');
  // ... 其他处理
  // 触发刷新资质档案事件
  window.dispatchEvent(new CustomEvent('archive-updated'));
}
```

**学业荣誉上传成功后**：
```typescript
if (response.data.code === 200) {
  toast.success('学业荣誉上传成功！');
  // ... 其他处理
  // 触发刷新资质档案事件
  window.dispatchEvent(new CustomEvent('archive-updated'));
}
```

**资质档案组件监听**：
```typescript
useEffect(() => {
  fetchArchive();
  
  // 监听上传成功事件，自动刷新资质档案
  const handleArchiveUpdate = () => {
    fetchArchive();
  };
  
  window.addEventListener('archive-updated', handleArchiveUpdate);
  
  return () => {
    window.removeEventListener('archive-updated', handleArchiveUpdate);
  };
}, []);
```

### 3. 数据查询优化

#### 工作证明查询
- ✅ 使用关联查询，自动获取兼职岗位信息（jobTitle, companyName）
- ✅ 按创建时间倒序排列，最新上传的显示在最前面

#### 学业荣誉查询
- ✅ 按创建时间倒序排列
- ✅ 支持可选字段（awardLevel, awardDate）为空的情况

### 4. 显示优化

#### 统计卡片
- ✅ **资质档案总数**: 显示工作证明和学业荣誉的总数
- ✅ **已核验档案**: 显示状态为 `VERIFIED` 的档案数量
- ✅ **档案复用**: 显示"可直接复用"提示

#### 列表显示
- ✅ 支持按类型筛选：全部档案、工作证明、学业荣誉
- ✅ 显示核验状态：待核验、已核验、核验失败
- ✅ 显示详细信息：工作期间、获奖日期、上传时间等
- ✅ 支持下载和删除操作

#### 空值处理
- ✅ `awardLevel` 为空时不显示
- ✅ `awardDate` 为空时不显示获奖日期
- ✅ `endDate` 为空时只显示开始日期
- ✅ `monthlyIncome` 为空时不显示月收入

## 数据流程

### 上传工作证明流程
```
1. 用户选择兼职岗位
2. 填写工作证明信息（证明类型、开始日期、月收入等）
3. 上传证明文件 → /api/upload
4. 提交工作证明数据 → /api/jobs/proof
5. 后端保存到 user_job_proof 表
6. 前端触发 'archive-updated' 事件
7. 资质档案组件自动刷新
8. 新上传的工作证明立即显示在资质档案中
```

### 上传学业荣誉流程
```
1. 用户填写学业荣誉信息（荣誉类型、荣誉名称、获奖级别等）
2. 上传证书文件 → /api/upload
3. 提交学业荣誉数据 → /api/academic-honors
4. 后端保存到 academic_honor 表
5. 前端触发 'archive-updated' 事件
6. 资质档案组件自动刷新
7. 新上传的学业荣誉立即显示在资质档案中
```

## 复用机制

### 申请贷款时复用
1. 用户在申请贷款时，系统自动查询用户的资质档案
2. 已核验的档案（`verification_status = 'VERIFIED'`）可以直接使用
3. 用户无需重复上传，系统自动关联到贷款申请

### 数据关联
- 工作证明关联到 `user_job_proof` 表，通过 `user_id` 关联用户
- 学业荣誉关联到 `academic_honor` 表，通过 `user_id` 关联用户
- 工作证明可以关联到 `part_time_job` 表，获取兼职岗位信息

## 测试验证

### 测试步骤
1. **上传工作证明**：
   - 进入"兼职推荐"页面
   - 选择一个兼职岗位
   - 点击"上传工作证明"
   - 填写信息并上传文件
   - 上传成功后，切换到"资质档案"页面
   - ✅ 验证：新上传的工作证明应该立即显示

2. **上传学业荣誉**：
   - 进入"学业荣誉"页面
   - 点击"上传证明"
   - 填写信息并上传文件
   - 上传成功后，切换到"资质档案"页面
   - ✅ 验证：新上传的学业荣誉应该立即显示

3. **统计信息更新**：
   - 上传前记录"资质档案总数"
   - 上传后检查总数是否增加
   - ✅ 验证：统计数字应该实时更新

4. **删除操作**：
   - 在资质档案页面删除一条记录
   - ✅ 验证：删除后列表应该立即更新，统计数字也应该更新

## 注意事项

1. ✅ **自动刷新**：上传成功后无需手动刷新页面，数据会自动更新
2. ✅ **实时统计**：统计卡片会实时显示最新的档案数量和核验状态
3. ✅ **数据持久化**：所有上传的数据都会保存到数据库，即使刷新页面也不会丢失
4. ✅ **权限控制**：用户只能查看和操作自己的资质档案
5. ✅ **数据复用**：已核验的档案可以在后续申请中直接复用

## 后续优化建议

1. **批量上传**：支持一次上传多个文件
2. **档案预览**：点击档案卡片可以预览文件内容
3. **档案编辑**：支持编辑已上传的档案信息
4. **档案导出**：支持导出资质档案为PDF
5. **智能推荐**：根据用户资质档案推荐合适的贷款产品

