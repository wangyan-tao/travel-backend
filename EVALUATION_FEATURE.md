# 测评问卷功能说明

## 功能概述

测评问卷功能用于在用户申请贷款产品前，评估用户的信用状况、还款能力和风险承受能力，以便为用户推荐最合适的贷款产品。

## 数据库变更

### 1. user_identity表新增字段

- `evaluation_completed`: 是否完成测评（0否 1是）
- `evaluation_score`: 测评总分
- `evaluation_level`: 测评等级（A/B/C/D）
- `evaluation_completed_at`: 测评完成时间

### 2. 新增evaluation_questionnaire表

存储用户的测评问卷详细数据，包括：
- 月收入范围
- 还款能力评估
- 信用记录
- 旅游预算
- 还款期限偏好
- 风险承受能力
- 测评总分和等级
- 详细答案（JSON格式）

## API接口

### 1. 提交测评问卷
- **路径**: `/evaluation/submit`
- **方法**: POST
- **权限**: 需要登录
- **请求体**:
```json
{
  "monthlyIncome": "1000-2000",
  "repaymentCapability": "可以还款",
  "creditRecord": "信用良好",
  "travelBudget": "2000-3000",
  "repaymentPreference": "3-6个月",
  "riskTolerance": "稳健型",
  "answers": {}
}
```

### 2. 获取测评结果
- **路径**: `/evaluation/result`
- **方法**: GET
- **权限**: 需要登录
- **返回**: 测评问卷详情

### 3. 检查是否完成测评
- **路径**: `/evaluation/check`
- **方法**: GET
- **权限**: 需要登录
- **返回**: boolean值，表示是否完成测评

## 测评评分规则

### 评分标准（总分100分）

1. **月收入范围** (0-20分)
   - 1000以下: 5分
   - 1000-2000: 10分
   - 2000-3000: 15分
   - 3000以上: 20分

2. **还款能力评估** (0-20分)
   - 完全无法还款: 0分
   - 还款困难: 5分
   - 可以还款: 15分
   - 轻松还款: 20分

3. **信用记录** (0-20分)
   - 有逾期记录: 0分
   - 信用一般: 10分
   - 信用良好: 15分
   - 信用优秀: 20分

4. **旅游预算** (0-15分)
   - 1000以下: 5分
   - 1000-2000: 10分
   - 2000-3000: 12分
   - 3000以上: 15分

5. **还款期限偏好** (0-15分)
   - 1-2个月: 5分
   - 3-6个月: 10分
   - 6-12个月: 12分
   - 12个月以上: 15分

6. **风险承受能力** (0-10分)
   - 保守型: 3分
   - 稳健型: 6分
   - 积极型: 8分
   - 激进型: 10分

### 等级划分

- **R1 低风险** (85-100分): 信用状况和还款能力优秀，可以申请较高额度的贷款产品
- **R2 中低风险** (70-84分): 信用状况和还款能力良好，可以申请中等额度的贷款产品
- **R3 中风险** (55-69分): 信用状况和还款能力一般，建议申请较低额度的贷款产品
- **R4 中高风险** (40-54分): 信用状况和还款能力需要提升，建议谨慎申请贷款
- **R5 高风险** (0-39分): 建议先提升信用状况和还款能力后再申请贷款

## 前端功能

### 1. 测评问卷页面 (`/evaluation`)

- 6道测评题目，分步显示
- 实时显示进度条
- 提交后显示测评结果和等级
- 完成后可跳转到产品列表页面

### 2. 产品选择页面 (`/loan-products`)

- 在用户点击"立即申请"时检查是否完成测评
- 如果未完成测评，弹出提示对话框
- 引导用户前往测评页面完成测评

## 部署说明

### 1. 数据库迁移

如果是新部署，直接执行 `schema.sql` 即可。

如果是现有数据库，需要执行迁移脚本：
```sql
-- 执行 migration_add_evaluation.sql
```

### 2. 后端部署

确保以下文件已正确部署：
- `EvaluationQuestionnaire.java` (实体类)
- `EvaluationQuestionnaireMapper.java` (Mapper)
- `EvaluationService.java` (服务类)
- `EvaluationController.java` (控制器)
- `EvaluationRequest.java` (DTO)
- 更新后的 `UserIdentity.java`

### 3. 前端部署

确保以下文件已正确部署：
- `Evaluation.tsx` (测评页面)
- 更新后的 `LoanProducts.tsx` (产品选择页面)
- 更新后的 `profileApi.ts` (API接口)
- 更新后的 `App.tsx` (路由配置)

## 使用流程

1. 用户登录系统
2. 用户浏览贷款产品列表
3. 用户点击"立即申请"时，系统检查是否完成测评
4. 如果未完成测评，弹出提示对话框
5. 用户点击"前往测评"，跳转到测评页面
6. 用户完成6道测评题目
7. 系统计算总分和等级，更新user_identity表
8. 用户返回产品列表，可以正常申请产品

## 注意事项

1. 测评结果会同步更新到 `user_identity` 表，方便后续查询
2. 测评问卷数据存储在 `evaluation_questionnaire` 表中，支持JSON格式存储详细答案
3. 用户只能提交一次测评，如需重新测评，需要先删除之前的记录
4. 测评完成后，用户才能申请贷款产品

