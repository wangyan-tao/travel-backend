# 上传功能排查指南

## 已完成的修复

### 1. 添加调试日志
- ✅ 前端添加了详细的 console.log，可以在浏览器控制台查看
- ✅ 后端添加了详细的 log.info，可以在后端日志中查看

### 2. 修复URL格式
- ✅ OssService 现在会自动为URL添加 `https://` 协议（如果缺失）

### 3. 优化参数处理
- ✅ 移除了前端传递但后端不保存的 `remarks` 字段
- ✅ 添加了 `Content-Type: application/json` 请求头
- ✅ 优化了可选字段的处理逻辑

## 排查步骤

### 步骤1：检查文件上传

1. **打开浏览器控制台**（F12）
2. **上传工作证明或学业荣誉**
3. **查看控制台输出**：
   - 应该看到：`文件上传成功，URL: https://...`
   - 如果看到错误，检查：
     - Token 是否有效
     - 文件大小是否超过限制（20MB）
     - 网络连接是否正常

### 步骤2：检查数据提交

1. **查看控制台输出**：
   - 应该看到：`提交工作证明数据: {...}` 或 `提交学业荣誉数据: {...}`
   - 检查数据格式是否正确

2. **查看响应**：
   - 应该看到：`工作证明提交响应: {code: 200, ...}` 或 `学业荣誉提交响应: {code: 200, ...}`
   - 如果 code 不是 200，查看 message 字段了解错误原因

### 步骤3：检查后端日志

1. **查看后端控制台输出**：
   - 应该看到：`上传工作证明 - userId: X, request: {...}`
   - 应该看到：`保存工作证明 - proof: {...}`
   - 应该看到：`工作证明保存成功 - id: X`

2. **如果看到错误**：
   - 检查数据库连接
   - 检查表结构是否正确
   - 检查必填字段是否都有值

### 步骤4：检查资质档案查询

1. **切换到资质档案页面**
2. **查看控制台输出**：
   - 应该看到：`开始获取资质档案...`
   - 应该看到：`工作证明响应: {code: 200, data: [...]}`
   - 应该看到：`工作证明数量: X`
   - 应该看到：`学业荣誉数量: X`

3. **如果数量为0但已上传**：
   - 检查 userId 是否正确
   - 检查数据库是否有数据
   - 检查查询SQL是否正确

## 常见问题

### 问题1：上传成功但资质档案不显示

**可能原因**：
1. 事件没有触发
2. 资质档案组件没有监听事件
3. 查询接口返回空数据

**解决方法**：
1. 检查控制台是否有 `archive-updated` 事件触发
2. 手动刷新资质档案页面
3. 检查后端日志，确认数据是否保存成功
4. 直接调用查询接口测试：`GET /api/jobs/proof` 和 `GET /api/academic-honors`

### 问题2：上传接口返回404

**可能原因**：
1. 后端服务未启动
2. 路径配置错误

**解决方法**：
1. 确认后端服务已启动（端口8080）
2. 检查 Controller 路径是否正确（应该是 `/jobs` 而不是 `/api/jobs`）
3. 检查 SecurityConfig 是否允许访问

### 问题3：上传接口返回401

**可能原因**：
1. Token 过期或无效
2. 请求头格式错误

**解决方法**：
1. 重新登录获取新Token
2. 检查请求头格式：`Authorization: Bearer YOUR_TOKEN`

### 问题4：文件上传失败

**可能原因**：
1. 七牛云配置错误
2. 文件大小超过限制
3. 文件格式不支持

**解决方法**：
1. 检查 `application.yml` 中的七牛云配置
2. 检查文件大小（限制20MB）
3. 检查文件格式（支持图片和PDF）

## 测试接口

### 1. 测试文件上传
```bash
curl -X POST "http://localhost:8080/api/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.jpg"
```

**预期响应**：
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "url": "https://t8c4m6g5o.hn-bkt.clouddn.com/xxx.jpg"
  }
}
```

### 2. 测试上传工作证明
```bash
curl -X POST "http://localhost:8080/api/jobs/proof" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "proofType": "工作证明",
    "proofUrl": "https://t8c4m6g5o.hn-bkt.clouddn.com/test.jpg",
    "startDate": "2024-01-01"
  }'
```

### 3. 测试查询工作证明列表
```bash
curl -X GET "http://localhost:8080/api/jobs/proof" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4. 测试上传学业荣誉
```bash
curl -X POST "http://localhost:8080/api/academic-honors" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "honorType": "奖学金",
    "honorName": "国家励志奖学金",
    "certificateUrl": "https://t8c4m6g5o.hn-bkt.clouddn.com/test.jpg"
  }'
```

### 5. 测试查询学业荣誉列表
```bash
curl -X GET "http://localhost:8080/api/academic-honors" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 数据库检查

### 检查工作证明数据
```sql
SELECT * FROM user_job_proof WHERE user_id = YOUR_USER_ID ORDER BY created_at DESC;
```

### 检查学业荣誉数据
```sql
SELECT * FROM academic_honor WHERE user_id = YOUR_USER_ID ORDER BY created_at DESC;
```

## 下一步

如果按照以上步骤排查后仍有问题，请提供：
1. 浏览器控制台的完整错误信息
2. 后端日志的完整输出
3. 网络请求的详细信息（可以在浏览器 Network 标签查看）

